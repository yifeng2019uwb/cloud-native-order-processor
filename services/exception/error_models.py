"""
RFC 7807 Problem Details Models

Implements RFC 7807 Problem Details for HTTP APIs
https://tools.ietf.org/html/rfc7807
"""

from datetime import datetime
from typing import Any, Dict, List, Optional, Union
from pydantic import BaseModel, Field

from .error_codes import ErrorCode, get_http_status_code, get_error_title


class ErrorDetails(BaseModel):
    """Individual field error details for validation errors"""
    field: str = Field(..., description="The field that failed validation")
    message: str = Field(..., description="Human-readable error message")
    value: Optional[Any] = Field(None, description="The invalid value that was provided")


class ProblemDetails(BaseModel):
    """
    RFC 7807 Problem Details for HTTP APIs

    This model implements the standard Problem Details format as defined in RFC 7807.
    All error responses should use this format for consistency.
    """

    # Required fields per RFC 7807
    type: str = Field(
        ...,
        description="A URI reference that identifies the problem type",
        example="https://github.com/yifeng2019uwb/cloud-native-order-processor/blob/main/docs/errors/validation-error.md"
    )
    title: str = Field(
        ...,
        description="A short, human-readable summary of the problem type",
        example="Validation Error"
    )
    status: int = Field(
        ...,
        description="The HTTP status code generated by the origin server for this occurrence of the problem",
        example=422
    )
    detail: str = Field(
        ...,
        description="A human-readable explanation specific to this occurrence of the problem",
        example="The request body contains invalid data"
    )

    # Optional fields per RFC 7807
    instance: Optional[str] = Field(
        None,
        description="A URI reference that identifies the specific occurrence of the problem",
        example="/api/v1/users"
    )

    # Custom fields for additional context
    errors: Optional[List[ErrorDetails]] = Field(
        None,
        description="Field-specific validation errors (for validation problems)"
    )
    timestamp: Optional[datetime] = Field(
        default_factory=datetime.utcnow,
        description="When the error occurred"
    )
    trace_id: Optional[str] = Field(
        None,
        description="Request trace ID for debugging"
    )

    class Config:
        json_schema_extra = {
            "example": {
                "type": "https://github.com/yifeng2019uwb/cloud-native-order-processor/blob/main/docs/errors/validation-error.md",
                "title": "Validation Error",
                "status": 422,
                "detail": "The request body contains invalid data",
                "instance": "/api/v1/auth/register",
                "errors": [
                    {
                        "field": "email",
                        "message": "Invalid email format",
                        "value": "invalid-email"
                    }
                ],
                "timestamp": "2024-01-15T10:30:00Z",
                "trace_id": "req-12345"
            }
        }


class ValidationError(ProblemDetails):
    """Specialized Problem Details for validation errors"""

    def __init__(self, **data):
        # Set default values for validation errors
        if 'type' not in data:
            data['type'] = "https://github.com/yifeng2019uwb/cloud-native-order-processor/blob/main/docs/errors/validation-error.md"
        if 'title' not in data:
            data['title'] = "Validation Error"
        if 'status' not in data:
            data['status'] = 422

        super().__init__(**data)


def create_problem_details(
    error_code: ErrorCode,
    detail: str,
    instance: Optional[str] = None,
    errors: Optional[List[ErrorDetails]] = None,
    trace_id: Optional[str] = None
) -> ProblemDetails:
    """
    Create a Problem Details response

    Args:
        error_code: The standard error code
        detail: Human-readable error message
        instance: The endpoint that caused the error
        errors: Field-specific validation errors (for validation problems)
        trace_id: Request trace ID for debugging

    Returns:
        ProblemDetails instance
    """

    # Get documentation URL based on error code
    doc_urls = {
        ErrorCode.VALIDATION_ERROR: "validation-error.md",
        ErrorCode.INVALID_INPUT: "validation-error.md",
        ErrorCode.MISSING_REQUIRED_FIELD: "validation-error.md",
        ErrorCode.INVALID_FORMAT: "validation-error.md",
        ErrorCode.AUTHENTICATION_FAILED: "authentication-error.md",
        ErrorCode.INVALID_CREDENTIALS: "authentication-error.md",
        ErrorCode.TOKEN_EXPIRED: "authentication-error.md",
        ErrorCode.TOKEN_INVALID: "authentication-error.md",
        ErrorCode.MISSING_TOKEN: "authentication-error.md",
        ErrorCode.INSUFFICIENT_PERMISSIONS: "authentication-error.md",
        ErrorCode.ACCESS_DENIED: "authentication-error.md",
        ErrorCode.RESOURCE_NOT_FOUND: "resource-not-found.md",
        ErrorCode.USER_NOT_FOUND: "resource-not-found.md",
        ErrorCode.ASSET_NOT_FOUND: "resource-not-found.md",
        ErrorCode.RESOURCE_ALREADY_EXISTS: "resource-exists.md",
        ErrorCode.USERNAME_TAKEN: "resource-exists.md",
        ErrorCode.EMAIL_TAKEN: "resource-exists.md",
        ErrorCode.INTERNAL_SERVER_ERROR: "internal-error.md",
        ErrorCode.SERVICE_UNAVAILABLE: "internal-error.md",
        ErrorCode.DATABASE_ERROR: "internal-error.md",
        ErrorCode.EXTERNAL_SERVICE_ERROR: "internal-error.md",
    }

    doc_file = doc_urls.get(error_code, "internal-error.md")
    type_url = f"https://github.com/yifeng2019uwb/cloud-native-order-processor/blob/main/docs/errors/{doc_file}"

    return ProblemDetails(
        type=type_url,
        title=get_error_title(error_code),
        status=get_http_status_code(error_code),
        detail=detail,
        instance=instance,
        errors=errors,
        trace_id=trace_id
    )


def create_validation_error(
    detail: str,
    errors: List[ErrorDetails],
    instance: Optional[str] = None,
    trace_id: Optional[str] = None
) -> ValidationError:
    """
    Create a validation error response

    Args:
        detail: Human-readable error message
        errors: Field-specific validation errors
        instance: The endpoint that caused the error
        trace_id: Request trace ID for debugging

    Returns:
        ValidationError instance
    """

    return ValidationError(
        type="https://github.com/yifeng2019uwb/cloud-native-order-processor/blob/main/docs/errors/validation-error.md",
        title="Validation Error",
        status=422,
        detail=detail,
        instance=instance,
        errors=errors,
        trace_id=trace_id
    )